<!DOCTYPE html>
<html>
<head>
    <title>Recon Scanner</title>
    <style>
        body {
            background:#020617;
            color:#e5e7eb;
            font-family:Arial;
            padding:40px;
        }
        h2, h3 { color:#38bdf8; }
        input, button {
            padding:10px;
            border-radius:6px;
            border:none;
        }
        button {
            background:#22c55e;
            cursor:pointer;
            margin-top:10px;
        }
        .panel {
            background:#020617;
            border:1px solid #1e293b;
            padding:15px;
            margin-top:15px;
            border-radius:8px;
            max-height:300px;
            overflow:auto;
        }
        .ip-row {
            display:flex;
            align-items:center;
            gap:10px;
            margin:5px 0;
        }
        pre { margin:0; white-space:pre-wrap; }

        .loader {
            display: none;
            margin-top: 15px;
            color: #38bdf8;
            font-weight: bold;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 3px solid #1e293b;
            border-top: 3px solid #38bdf8;
            border-radius: 50%;
            display: inline-block;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        button:disabled {
            background: #475569;
            cursor: not-allowed;
        }

        button.locked {
            background: #475569 !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
            opacity: 0.7;
        }

        
        
        
        
        
        


    </style>
</head>
<body>

<h2>BUG FREE - Recon Scanner</h2>

<form method="POST" onsubmit="return handleEnumerateSubmit()">
    <input
            type="text"
            id="domainInput"
            name="domain"
            placeholder="example.com"
            value="{{ domain }}"
            required
            {% if scan_running %}disabled{% endif %}
        >
    <button
        type="submit"
        id="enumBtn"
        {% if scan_running %}disabled class="locked"{% endif %}
    >
        <span id="enumText">
            {% if scan_running %}Scan in progress…{% else %}Enumerate{% endif %}
        </span>
    </button>
</form>


{% if all_subdomains %}
<h3>All Subdomains</h3>
<div class="panel"><pre>{% for s in all_subdomains %}{{ s }}
{% endfor %}</pre></div>
{% endif %}

{% if active_subdomains %}
<h3>Active Subdomains</h3>
<div class="panel"><pre>{% for s in active_subdomains %}{{ s }}
{% endfor %}</pre></div>
{% endif %}

{% if ip_list %}
<h3>Select IPs for Port Scan</h3>
<div class="panel" id="ipPanel">
{% for ip in ip_list %}
<div class="ip-row">
    <input type="checkbox" class="ip-checkbox" value="{{ ip }}">
    {{ ip }}
</div>
{% endfor %}
</div>

<button id="scanBtn" onclick="startScan()">Start Port Scan</button>

<div class="loader" id="loader">
    <span class="spinner"></span> Scanning ports… please wait
</div>

<h3>Open Ports</h3>
<div class="panel">
    <pre id="ports">Waiting…</pre>
</div>

{% endif %}

<script>
let portScanRunning = false;

function handleEnumerateSubmit() {
    if (portScanRunning) {
        alert("Port scan is in progress. Please wait until it completes.");
        return false;
    }
    return true;
}

function setPortScanUIState(isScanning) {
    const enumBtn = document.getElementById("enumBtn");
    const enumText = document.getElementById("enumText");
    const scanBtn = document.getElementById("scanBtn");
    const domainInput = document.getElementById("domainInput");

    portScanRunning = isScanning;

    // Enumerate button
    enumBtn.disabled = isScanning;
    enumBtn.classList.toggle("locked", isScanning);
    enumText.innerText = isScanning ? "Scan in progress…" : "Enumerate";

    // Domain input
    domainInput.disabled = isScanning;

    // Scan button
    scanBtn.disabled = isScanning;
    scanBtn.classList.toggle("locked", isScanning);

    // IP checkboxes
    document.querySelectorAll(".ip-checkbox").forEach(cb => {
        cb.disabled = isScanning;
    });

    // Loader
    document.getElementById("loader").style.display =
        isScanning ? "block" : "none";
}

function startScan() {
    const ips = Array.from(
        document.querySelectorAll(".ip-checkbox:checked")
    ).map(cb => cb.value);

    if (ips.length === 0) {
        alert("Select at least one IP");
        return;
    }

    setPortScanUIState(true);
    document.getElementById("ports").innerText = "Scanning…";

    fetch("/start-port-scan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ips })
    });

    poll();
}

function poll() {
    fetch("/port-status")
        .then(r => r.json())
        .then(data => {
            let out = "";

            for (let ip in data.results) {
                const ports = data.results[ip];
                out += ip + " → " +
                    (ports.length ? ports.join(", ") : "No open ports") + "\n";
            }

            document.getElementById("ports").innerText =
                out || (data.running ? "Scanning…" : "Done");

            if (data.done) {
                setPortScanUIState(false);
            } else {
                setTimeout(poll, 3000);
            }
        })
        .catch(() => {
            setPortScanUIState(false);
            document.getElementById("ports").innerText = "Port scan error";
        });
}

/* ✅ THIS MUST BE OUTSIDE */
window.addEventListener("load", () => {
    fetch("/port-status")
        .then(r => r.json())
        .then(data => {
            if (data.running) {
                setPortScanUIState(true);
                document.getElementById("ports").innerText = "Scanning…";
                poll();
            }
        })
        .catch(() => {
            console.warn("Could not restore port scan state");
        });
});
</script>


</body>
</html>
