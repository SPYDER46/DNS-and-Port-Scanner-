<!DOCTYPE html>
<html>
<head>
    <title> DNS & Port Scanner </title>
<style>
    body {
        background: #f1f5f9;
        font-family: "Segoe UI", Arial, sans-serif;
        margin: 0;
        padding: 40px;
        display: flex;
        justify-content: center;
    }

    .container {
        background: #ffffff;
        width: 100%;
        max-width: 900px;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    h2 {
        color: #0f172a;
        margin-bottom: 5px;
        text-align: center;
    }

    h3 {
        color: #1e293b;
        margin-top: 30px;
        margin-bottom: 10px;
    }

    input, button {
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid #cbd5f5;
        font-size: 14px;
    }

    input:disabled {
        background: #f8fafc;
        color: #64748b;
    }

    button {
        background: #2563eb;
        color: #ffffff;
        border: none;
        cursor: pointer;
        font-weight: 600;
    }

    button:hover:not(:disabled) {
        background: #1d4ed8;
    }

    button:disabled,
    button.locked {
        background: #94a3b8;
        cursor: not-allowed;
    }

    form {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }

    .panel {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 15px;
        border-radius: 8px;
        max-height: 250px;
        overflow: auto;
        font-size: 14px;
    }

    .ip-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 5px 0;
    }

    .loader {
        margin-top: 15px;
        padding: 10px;
        background: #eef2ff;
        border: 1px solid #c7d2fe;
        border-radius: 6px;
        color: #1e3a8a;
        font-weight: 500;
        display: none;
    }

    pre {
        margin: 0;
        white-space: pre-wrap;
    }

    .center {
        text-align: center;
        margin-top: 15px;
    }
</style>

</head>
<body>
<div class="container">

<h2>BUG FREE – Recon Scanner</h2>
<p class="center" style="color:#475569;">
    Enumerate subdomains, identify active hosts, and scan IPs for open ports.
</p>


<form method="POST" onsubmit="return handleEnumerateSubmit()">
    <input
            type="text"
            id="domainInput"
            name="domain"
            placeholder="example.com"
            value="{{ domain }}"
            required
            {% if scan_running %}disabled{% endif %}
        >
    <button
        type="submit"
        id="enumBtn"
        {% if scan_running %}disabled class="locked"{% endif %}
    >
        <span id="enumText">
            {% if scan_running %}Scan in progress…{% else %}Enumerate{% endif %}
        </span>
    </button>
</form>


{% if all_subdomains %}
<h3>All Subdomains</h3>
<div class="panel"><pre>{% for s in all_subdomains %}{{ s }}
{% endfor %}</pre></div>
{% endif %}

{% if active_subdomains %}
<h3>Active Subdomains</h3>
<div class="panel"><pre>{% for s in active_subdomains %}{{ s }}
{% endfor %}</pre></div>
{% endif %}

{% if ip_list %}
<h3>Select IPs for Port Scan</h3>
<div class="panel" id="ipPanel">
{% for ip in ip_list %}
<div class="ip-row">
    <input type="checkbox" class="ip-checkbox" value="{{ ip }}">
    {{ ip }}
</div>
{% endfor %}
</div>

<div class="center" style="margin-top: 20px;">
    <button id="scanBtn" onclick="startScan()"> Port Scan </button>
</div>


<div class="loader" id="loader">
    <span class="spinner"></span> Scanning ports… please wait
</div>

<h3>Open Ports</h3>
<div class="panel">
    <pre id="ports">Waiting…</pre>
</div>

{% endif %}

<script>
let portScanRunning = false;

function handleEnumerateSubmit() {
    if (portScanRunning) {
        alert("Port scan is in progress. Please wait until it completes.");
        return false;
    }
    return true;
}

function setPortScanUIState(isScanning) {
    const enumBtn = document.getElementById("enumBtn");
    const enumText = document.getElementById("enumText");
    const scanBtn = document.getElementById("scanBtn");
    const domainInput = document.getElementById("domainInput");

    portScanRunning = isScanning;

    // Enumerate button
    enumBtn.disabled = isScanning;
    enumBtn.classList.toggle("locked", isScanning);
    enumText.innerText = isScanning ? "Scan in progress…" : "Enumerate";

    // Domain input
    domainInput.disabled = isScanning;

    // Scan button
    scanBtn.disabled = isScanning;
    scanBtn.classList.toggle("locked", isScanning);

    // IP checkboxes
    document.querySelectorAll(".ip-checkbox").forEach(cb => {
        cb.disabled = isScanning;
    });

    // Loader
    document.getElementById("loader").style.display =
        isScanning ? "block" : "none";
}

function startScan() {
    const ips = Array.from(
        document.querySelectorAll(".ip-checkbox:checked")
    ).map(cb => cb.value);

    if (ips.length === 0) {
        alert("Select at least one IP");
        return;
    }

    setPortScanUIState(true);
    document.getElementById("ports").innerText = "Scanning…";

    fetch("/start-port-scan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ips })
    });

    poll();
}

function poll() {
    fetch("/port-status")
        .then(r => r.json())
        .then(data => {
            let out = "";

            for (let ip in data.results) {
                const ports = data.results[ip];
                out += ip + " → " +
                    (ports.length ? ports.join(", ") : "No open ports") + "\n";
            }

            document.getElementById("ports").innerText =
                out || (data.running ? "Scanning…" : "Done");

            if (data.done) {
                setPortScanUIState(false);
            } else {
                setTimeout(poll, 3000);
            }
        })
        .catch(() => {
            setPortScanUIState(false);
            document.getElementById("ports").innerText = "Port scan error";
        });
}

/* THIS MUST BE OUTSIDE */
window.addEventListener("load", () => {
    fetch("/port-status")
        .then(r => r.json())
        .then(data => {
            if (data.running) {
                setPortScanUIState(true);
                document.getElementById("ports").innerText = "Scanning…";
                poll();
            }
        })
        .catch(() => {
            console.warn("Could not restore port scan state");
        });
});
</script>

</div>

</body>
</html>
