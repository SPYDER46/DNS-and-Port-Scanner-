<!DOCTYPE html>
<html>
<head>
    <title>DNS and Port Scanner</title>

<style>
    :root {
        --bg-page:#f4f6f8;
        --bg-panel:#ffffff;
        --border:#e5e7eb;
        --primary:#2563eb;
        --success:#16a34a;
        --danger:#dc2626;
        --text-main:#0f172a;
        --text-muted:#6b7280;
    }

    body {
        margin:0;
        min-height:100vh;
        background:var(--bg-page);
        color:var(--text-main);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        padding:24px;
    }

    /* ===== PAGE WRAP FEEL ===== */
    body::before {
        content:"";
        position:fixed;
        inset:0;
        background:var(--bg-page);
        z-index:-1;
    }

    h2 {
        text-align:center;
        font-size:22px;
        margin-bottom:18px;
        color:var(--text-main);
    }

    h3 {
        margin-top:32px;
        font-size:14px;
        font-weight:600;
        color:#1f2937;
        display:flex;
        align-items:center;
        gap:8px;
        padding-bottom:6px;
        border-bottom:1px solid var(--border);
    }

    /* ===== TOP FORM ===== */
    .top-center {
        max-width:1200px;
        margin:0 auto 30px auto;
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:16px;
    }

    .top-center form {
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        background:var(--bg-panel);
        padding:16px;
        border-radius:8px;
        border:1px solid var(--border);
    }

    input {
        padding:9px 12px;
        border-radius:6px;
        border:1px solid var(--border);
        background:#ffffff;
        color:var(--text-main);
        font-size:13px;
        /* min-width:240px; */
        outline:none;
    }

    input::placeholder {
        color:#9ca3af;
    }

    /* ===== BUTTONS ===== */
    button {
        padding:9px 16px;
        border-radius:6px;
        border:1px solid transparent;
        font-size:13px;
        font-weight:600;
        cursor:pointer;
        background:var(--success);
        color:#ffffff;
    }

    button[type="button"] {
        background:var(--danger);
    }

    button:disabled {
        background:#9ca3af;
        cursor:not-allowed;
    }

    /* ===== CONTENT AREA ===== */
    h3,
    .box,
    #portScanBtn {
        max-width:1200px;
        margin-left:auto;
        margin-right:auto;
    }

    .box {
        background:var(--bg-panel);
        border:1px solid var(--border);
        border-radius:8px;
        padding:14px;
        margin-top:10px;
        max-height:280px;
        overflow:auto;
        font-size:12px;
    }

    pre {
        margin:0;
        white-space:pre-wrap;
        line-height:1.45;
        font-family: Consolas, Monaco, monospace;
        color:#111827;
    }

    strong {
        font-weight:600;
        color:#111827;
    }

    label {
        display:flex;
        align-items:center;
        gap:8px;
        font-size:12px;
        padding:4px 0;
        cursor:pointer;
    }

    input[type="checkbox"] {
        accent-color:var(--primary);
    }

    .muted {
        color:var(--text-muted);
        font-size:12px;
    }

    /* ===== PORT SCAN BUTTON ===== */
    #portScanBtn {
        display:block;
        margin:32px auto 10px auto;
    }

    #ports {
        color:#1d4ed8;
        font-weight:500;
    }

    /* ===== LOADER ===== */
    .loader {
        width:12px;
        height:12px;
        border:2px solid #d1d5db;
        border-top:2px solid var(--primary);
        border-radius:50%;
        animation:spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform:rotate(0deg); }
        100% { transform:rotate(360deg); }
    }

    /* ===== SCROLLBAR ===== */
    .box::-webkit-scrollbar {
        width:6px;
    }

    .box::-webkit-scrollbar-thumb {
        background:#cbd5e1;
        border-radius:4px;
    }

    .box::-webkit-scrollbar-track {
        background:#f9fafb;
    }

    /* ===== MOBILE ===== */
    @media (max-width:600px) {
        input {
            min-width:100%;
        }
        .top-center form {
            width:100%;
        }
    }
</style>


</head>

<body>

<div class="top-center">
    <h2> BUG FREE - RECON SCANNER </h2>

    <form method="POST" onsubmit="disableEnumBtn()">
        <input id="domainInput" name="domain" value="{{ domain }}" placeholder="example.com" required>
        <button id="enumBtn" type="submit">Enumerate DNS</button>
        <button type="button" onclick="stopAll()">Stop</button>
    </form>
</div>

<h3>
    All Subdomains
    {% if not all_subs %}<span class="loader"></span>{% endif %}
</h3>

<div class="box">
{% if all_subs %}
<pre>{% for s in all_subs %}{{ s }}
{% endfor %}</pre>
{% else %}
<div class="muted">Waiting for subdomain enumeration…</div>
{% endif %}
</div>

<h3>
    Active Subdomains
    {% if not active_subs %}<span class="loader"></span>{% endif %}
</h3>

<div class="box">
{% if active_subs %}
<pre>{% for s in active_subs %}{{ s }}
{% endfor %}</pre>
{% else %}
<div class="muted">Resolving DNS records…</div>
{% endif %}
</div>

<h3>
    IP Addresses (Select IP to Scan)
    {% if not ip_map %}<span class="loader"></span>{% endif %}
</h3>

<div class="box">
{% if ip_map %}
<form id="ipForm">
{% for sub, ips in ip_map.items() %}
<strong>{{ sub }}</strong><br>
{% for ip in ips %}
<label>
    <input type="checkbox" value="{{ ip }}" checked>
    {{ ip }}
</label><br>
{% endfor %}
<br>
{% endfor %}
</form>
{% else %}
<div class="muted">Extracting IP addresses…</div>
{% endif %}
</div>

<button id="portScanBtn" onclick="startScan()">Port Scan</button>

<h3>
    Open Ports
    <span id="portLoader" class="loader" style="display:none;"></span>
</h3>

<div class="box">
    <pre id="ports">Waiting…</pre>
</div>

<script>
/* ===== FLAGS (ADDED) ===== */
let enumRunning = false;
let portRunning = false;
let stopPolling = false;

/* Disable Enumerate button */
function disableEnumBtn() {
    enumRunning = true;
    document.getElementById("enumBtn").disabled = true;

    /* ✅ RESET stopped text when new enumeration starts */
    document.querySelectorAll('.muted')
        .forEach(m => {
            if (m.innerText === 'Stopped by user') {
                m.innerText = 'Waiting for subdomain enumeration…';
            }
        });

    /* Show loaders again */
    document.querySelectorAll('.loader')
        .forEach(l => l.style.display = 'inline-block');
}

/* Get selected IPs */
function getSelectedIPs() {
    return Array.from(
        document.querySelectorAll('#ipForm input[type="checkbox"]:checked')
    ).map(cb => cb.value);
}

/* Start Port Scan */
function startScan() {
    const ips = getSelectedIPs();
    if (!ips.length) {
        document.getElementById("ports").innerText = "No IPs selected";
        return;
    }

    portRunning = true;
    stopPolling = false;

    document.getElementById("domainInput").disabled = true;
    document.getElementById("enumBtn").disabled = true;
    document.getElementById("portScanBtn").disabled = true;
    disableIPCheckboxes();

    document.getElementById("ports").innerText = "Starting port scan…";
    document.getElementById("portLoader").style.display = "inline-block";

    fetch("/start-port-scan", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ ips })
    });

    poll();
}

/* Poll scan status */
function poll() {
    if (stopPolling) return;

    fetch("/port-status")
        .then(r => r.json())
        .then(data => {
            let out = "";

            for (let ip in data.ports) {
                const ports = data.ports[ip];
                out += ip + " → " +
                    (ports.length ? ports.join(", ") : "No open ports") + "\n";
            }

            document.getElementById("ports").innerText =
                out || (data.running ? "Scanning…" : "Done");

            if (!data.done) {
                setTimeout(poll, 3000);
            } else {
                portRunning = false;

                document.getElementById("domainInput").disabled = false;
                document.getElementById("enumBtn").disabled = false;
                document.getElementById("portScanBtn").disabled = false;
                enableIPCheckboxes();
                document.getElementById("portLoader").style.display = "none";
            }
        });
}

/* ===== SINGLE STOP BUTTON ===== */
function stopAll() {
     window.stop();
    /* Stop enumeration UI */
    if (enumRunning) {
        enumRunning = false;
        document.getElementById("domainInput").disabled = false;
        document.getElementById("enumBtn").disabled = false;

        document.querySelectorAll('.loader')
            .forEach(l => l.style.display = 'none');

        document.querySelectorAll('.muted')
            .forEach(m => {
                if (
                    m.innerText.includes('Waiting') ||
                    m.innerText.includes('Resolving')
                ) {
                    m.innerText = 'Stopped by user';
                }
            });
    }

    /* Stop port scan UI */
    if (portRunning) {
        stopPolling = true;
        portRunning = false;

        document.getElementById("ports").innerText = "Scan stopped by user";
        document.getElementById("portLoader").style.display = "none";

        document.getElementById("domainInput").disabled = false;
        document.getElementById("enumBtn").disabled = false;
        document.getElementById("portScanBtn").disabled = false;
        enableIPCheckboxes();
    }
}

/* Helpers */
function disableIPCheckboxes() {
    document.querySelectorAll('#ipForm input[type="checkbox"]')
        .forEach(cb => cb.disabled = true);
}

function enableIPCheckboxes() {
    document.querySelectorAll('#ipForm input[type="checkbox"]')
        .forEach(cb => cb.disabled = false);
}

/* Prevent POST resubmission */
if (window.history.replaceState) {
    window.history.replaceState(null, null, window.location.href);
}
</script>

</body>
</html>
