<!DOCTYPE html>
<html>
<head>
    <title>DNS and Port Scanner</title>

    <style>
        body {
            background:#0f172a;
            color:#e5e7eb;
            font-family:Arial;
            padding:40px;
        }

        h2 { color:#38bdf8; text-align:center; }

        h3 {
            color:#38bdf8;
            display:flex;
            align-items:center;
            gap:8px;
        }

        button {
            padding:10px 16px;
            background:#22c55e;
            border:none;
            cursor:pointer;
            border-radius:6px;
            font-weight:bold;
        }

        button:disabled {
            background:#475569;
            cursor:not-allowed;
        }

        input {
            padding:10px;
            border-radius:6px;
            border:none;
        }

        .top-center {
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:15px;
            margin-bottom:30px;
        }

        .box {
            background:#020617;
            padding:15px;
            margin-top:10px;
            border-radius:6px;
            max-height:300px;
            overflow:auto;
            font-size:14px;
        }

        pre { margin:0; white-space:pre-wrap; }

        .loader {
            width:14px;
            height:14px;
            border:3px solid #1e293b;
            border-top:3px solid #38bdf8;
            border-radius:50%;
            animation:spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform:rotate(0deg); }
            100% { transform:rotate(360deg); }
        }

        .muted {
            color:#64748b;
            font-size:13px;
        }
    </style>
</head>

<body>

<div class="top-center">
    <h2>Automate Recon Scanner</h2>

    <form method="POST" onsubmit="disableEnumBtn()">
        <input id="domainInput" name="domain" value="{{ domain }}" placeholder="example.com" required>
        <button id="enumBtn" type="submit">Enumerate DNS</button>
        <button type="button" onclick="stopAll()">Stop</button>
    </form>
</div>

<h3>
    All Subdomains
    {% if not all_subs %}<span class="loader"></span>{% endif %}
</h3>

<div class="box">
{% if all_subs %}
<pre>{% for s in all_subs %}{{ s }}
{% endfor %}</pre>
{% else %}
<div class="muted">Waiting for subdomain enumeration…</div>
{% endif %}
</div>

<h3>
    Active Subdomains
    {% if not active_subs %}<span class="loader"></span>{% endif %}
</h3>

<div class="box">
{% if active_subs %}
<pre>{% for s in active_subs %}{{ s }}
{% endfor %}</pre>
{% else %}
<div class="muted">Resolving DNS records…</div>
{% endif %}
</div>

<h3>
    IP Addresses (Select IP to Scan)
    {% if not ip_map %}<span class="loader"></span>{% endif %}
</h3>

<div class="box">
{% if ip_map %}
<form id="ipForm">
{% for sub, ips in ip_map.items() %}
<strong>{{ sub }}</strong><br>
{% for ip in ips %}
<label>
    <input type="checkbox" value="{{ ip }}" checked>
    {{ ip }}
</label><br>
{% endfor %}
<br>
{% endfor %}
</form>
{% else %}
<div class="muted">Extracting IP addresses…</div>
{% endif %}
</div>

<button id="portScanBtn" onclick="startScan()">Port Scan</button>

<h3>
    Open Ports
    <span id="portLoader" class="loader" style="display:none;"></span>
</h3>

<div class="box">
    <pre id="ports">Waiting…</pre>
</div>

<script>
/* ===== FLAGS (ADDED) ===== */
let enumRunning = false;
let portRunning = false;
let stopPolling = false;

/* Disable Enumerate button */
function disableEnumBtn() {
    enumRunning = true;
    document.getElementById("enumBtn").disabled = true;

    /* ✅ RESET stopped text when new enumeration starts */
    document.querySelectorAll('.muted')
        .forEach(m => {
            if (m.innerText === 'Stopped by user') {
                m.innerText = 'Waiting for subdomain enumeration…';
            }
        });

    /* Show loaders again */
    document.querySelectorAll('.loader')
        .forEach(l => l.style.display = 'inline-block');
}

/* Get selected IPs */
function getSelectedIPs() {
    return Array.from(
        document.querySelectorAll('#ipForm input[type="checkbox"]:checked')
    ).map(cb => cb.value);
}

/* Start Port Scan */
function startScan() {
    const ips = getSelectedIPs();
    if (!ips.length) {
        document.getElementById("ports").innerText = "No IPs selected";
        return;
    }

    portRunning = true;
    stopPolling = false;

    document.getElementById("domainInput").disabled = true;
    document.getElementById("enumBtn").disabled = true;
    document.getElementById("portScanBtn").disabled = true;
    disableIPCheckboxes();

    document.getElementById("ports").innerText = "Starting port scan…";
    document.getElementById("portLoader").style.display = "inline-block";

    fetch("/start-port-scan", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ ips })
    });

    poll();
}

/* Poll scan status */
function poll() {
    if (stopPolling) return;

    fetch("/port-status")
        .then(r => r.json())
        .then(data => {
            let out = "";

            for (let ip in data.ports) {
                const ports = data.ports[ip];
                out += ip + " → " +
                    (ports.length ? ports.join(", ") : "No open ports") + "\n";
            }

            document.getElementById("ports").innerText =
                out || (data.running ? "Scanning…" : "Done");

            if (!data.done) {
                setTimeout(poll, 3000);
            } else {
                portRunning = false;

                document.getElementById("domainInput").disabled = false;
                document.getElementById("enumBtn").disabled = false;
                document.getElementById("portScanBtn").disabled = false;
                enableIPCheckboxes();
                document.getElementById("portLoader").style.display = "none";
            }
        });
}

/* ===== SINGLE STOP BUTTON ===== */
function stopAll() {
     window.stop();
    /* Stop enumeration UI */
    if (enumRunning) {
        enumRunning = false;
        document.getElementById("domainInput").disabled = false;
        document.getElementById("enumBtn").disabled = false;

        document.querySelectorAll('.loader')
            .forEach(l => l.style.display = 'none');

        document.querySelectorAll('.muted')
            .forEach(m => {
                if (
                    m.innerText.includes('Waiting') ||
                    m.innerText.includes('Resolving')
                ) {
                    m.innerText = 'Stopped by user';
                }
            });
    }

    /* Stop port scan UI */
    if (portRunning) {
        stopPolling = true;
        portRunning = false;

        document.getElementById("ports").innerText = "Scan stopped by user";
        document.getElementById("portLoader").style.display = "none";

        document.getElementById("domainInput").disabled = false;
        document.getElementById("enumBtn").disabled = false;
        document.getElementById("portScanBtn").disabled = false;
        enableIPCheckboxes();
    }
}

/* Helpers */
function disableIPCheckboxes() {
    document.querySelectorAll('#ipForm input[type="checkbox"]')
        .forEach(cb => cb.disabled = true);
}

function enableIPCheckboxes() {
    document.querySelectorAll('#ipForm input[type="checkbox"]')
        .forEach(cb => cb.disabled = false);
}

/* Prevent POST resubmission */
if (window.history.replaceState) {
    window.history.replaceState(null, null, window.location.href);
}
</script>

</body>
</html>
